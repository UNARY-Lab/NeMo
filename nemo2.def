Bootstrap: docker
From: nvcr.io/nvidia/pytorch:24.07-py3

%environment
	TRANSFORMERS_OFFLINE=0
	HYDRA_FULL_ERROR=1
	PYTHONUNBUFFERED=1

%files
	./requirements /workspace/requirements
	./tools /workspace/tools
	./setup.py /workspace/setup.py
	./nemo/package_info.py /workspace/nemo/package_info.py
	./nemo/__init__.py /workspace/nemo/__init__.py
	. /NeMo/

%post
	set -ex

	apt-get update
	apt-get install -y bc libsox-fmt-all -y # --no-upgrade
	apt-get clean

	cd /workspace

	export CAUSAL_CONV_TAG=v1.2.2.post1
	git clone --depth 1 --branch ${CAUSAL_CONV_TAG} https://github.com/Dao-AILab/causal-conv1d && \
		cd causal-conv1d && \
		python setup.py install && \
		cd .. && \
		rm -rf causal-conv1d

	pip install hatchling
	export NEMO_RUN_TAG=34259bd3e752fef94045a9a019e4aaf62bd11ce2
	pip install nemo_run@git+https://github.com/NVIDIA/NeMo-Run.git@${NEMO_RUN_TAG}
	
	export TE_TAG=7d576ed25266a17a7b651f2c12e8498f67e0baea
	export MODELOPT_VERSION=0.19.0
	export MCORE_TAG=core_r0.10.0

	export APEX_TAG=810ffae374a2b9cb4b5c5e28eaeca7d7998fca0c
	pip install --no-cache-dir --no-build-isolation --extra-index-url https://pypi.nvidia.com \
		"transformer-engine @ git+https://github.com/NVIDIA/TransformerEngine.git@${TE_TAG}" \
		"megatron_core @ git+https://github.com/NVIDIA/Megatron-LM.git@${MCORE_TAG}" \
		"nvidia-modelopt[torch]~=${MODELOPT_VERSION}" \
		"apex @ git+https://github.com/NVIDIA/apex.git@${APEX_TAG}" \
		"unstructured==0.14.9" \
		"llama-index==0.10.43" \
		"onnxscript @ git+https://github.com/microsoft/onnxscript" \
		-r tools/ctc_segmentation/requirements.txt \
		".[all]"

	git clone https://github.com/NVIDIA/Megatron-LM.git && \
	pushd Megatron-LM && \
	git checkout ${MCORE_TAG} && \
	  pushd megatron/core/datasets && \
	  make && \
	  popd && \
	popd
	export PYTHONPATH="${PYTHONPATH}:/workspace/Megatron-LM"

	pip install --no-cache-dir "git+https://github.com/NVIDIA/nvidia-resiliency-ext.git@97aad77609d2e25ed38ac5c99f0c13f93c48464e"

	cd /NeMo
	pip install --no-cache-dir --no-build-isolation ".[all]"

	chmod 777 -R /workspace
	chmod 777 -R /NeMo

	echo 'export PYTHONPATH="${PYTHONPATH}:/workspace/Megatron-LM"' >> $APPTAINER_ENVIRONMENT
